<!DOCTYPE html>
<html lang="en">
  <head>
    <title>JSONCache  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="JSONCache  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">JSONCache Docs</a> (100% documented)</p>
        <p class="header-right"><a href="https://github.com/andersblehr/JSONCache"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">JSONCache Reference</a>
        <img id="carat" src="img/carat.png" />
        JSONCache  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/ResultPromise.html">ResultPromise</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/JSONCacheError.html">JSONCacheError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/Date.html">Date</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/DateFormatter.html">DateFormatter</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSAttributeDescription.html">NSAttributeDescription</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSEntityDescription.html">NSEntityDescription</a>
              </li>
              <li class="nav-group-task">
                <a href="Extensions/NSManagedObject.html">NSManagedObject</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/JSONifiable.html">JSONifiable</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/JSONCache.html">JSONCache</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/JSONCache/Casing.html">– Casing</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/JSONCache/DateFormat.html">– DateFormat</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/JSONConverter.html">JSONConverter</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/JSONConverter/Conversion.html">– Conversion</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='jsoncache' class='heading'>JSONCache</h1>

<p><a href="https://travis-ci.org/andersblehr/JSONCache"><img src="https://travis-ci.org/andersblehr/JSONCache.svg?branch=master" alt="Build Status"></a>
<a href="https://github.com/Carthage/Carthage"><img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible"></a>
<a href="https://cocoapods.org/"><img src="https://img.shields.io/cocoapods/v/JSONCache.svg" alt="CocoaPods"></a>
<img src="https://img.shields.io/cocoapods/p/JSONCache.svg" alt="Platform">
<img src="https://img.shields.io/cocoapods/l/JSONCache.svg" alt="license MIT"></p>

<!-- [![codecov](https://codecov.io/gh/andersblehr/JSONCache/branch/master/graph/badge.svg)](https://codecov.io/gh/andersblehr/JSONCache) -->

<!-- [![CocoaDocs](https://img.shields.io/cocoapods/metrics/doc-percent/JSONCache.svg)](http://cocoadocs.org/docsets/JSONCache) -->

<p>JSONCache is a thin layer on top of Core Data that seamlessly consumes, caches and produces JSON data.</p>

<ul>
<li>Automatically creates Core Data objects from JSON data, or merges JSON data into objects that already exist.</li>
<li>Automatically maps 1:1 and 1:N relationships based on inferred knowledge of your Core Data model.</li>
<li>If necessary, automatically maps between <code>snake_case</code> in JSON key names and <code>camelCase</code> in Core Data attribute names.</li>
<li>Generates JSON on demand, both from <code>NSManagedObject</code> instances, and from any <code>struct</code> that adopts the <code><a href="Protocols/JSONifiable.html">JSONifiable</a></code> protocol.</li>
<li>Operates on background threads to avoid interfering with your app&rsquo;s responsiveness.</li>
</ul>

<p>Read the <a href="https://andersblehr.github.io/JSONCache">API documentation</a> for the complete picture.</p>
<h2 id='content' class='heading'>Content</h2>

<ul>
<li><a href="#show-dont-tell">Show, don&rsquo;t tell</a>

<ul>
<li><a href="#consuming-json">Consuming JSON</a></li>
<li><a href="#producing-json">Producing JSON</a></li>
<li><a href="#avoiding-the-pyramid-of-doom">Avoiding the pyramid of doom</a></li>
</ul></li>
<li><a href="#but-do-tell">But do tell</a>

<ul>
<li><a href="#key-conversion">Key conversion</a></li>
<li><a href="#case-conversion">Case conversion</a></li>
<li><a href="#qualifying-reserved-words">Qualifying reserved words</a></li>
<li><a href="#date-conversion">Date conversion</a></li>
<li><a href="#relationship-mapping">Relationship mapping</a></li>
<li><a href="#how-to">How to &hellip;</a></li>
<li><a href="#but-how">But how &hellip;?</a></li>
</ul></li>
<li><a href="#installation">Installation</a>

<ul>
<li><a href="#cocoapods">CocoaPods</a></li>
<li><a href="#carthage">Carthage</a></li>
<li><a href="#compatibility">Compatibility</a></li>
</ul></li>
<li><a href="#license">License</a></li>
</ul>
<h2 id='show-don-39-t-tell' class='heading'>Show, don&rsquo;t tell</h2>
<h3 id='consuming-json' class='heading'>Consuming JSON</h3>

<p>Say your backend produces JSON like this:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"bands"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Japan"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"formed"</span><span class="p">:</span><span class="w"> </span><span class="mi">1974</span><span class="p">,</span><span class="w">
      </span><span class="s2">"disbanded"</span><span class="p">:</span><span class="w"> </span><span class="mi">1991</span><span class="p">,</span><span class="w">
      </span><span class="s2">"hiatus"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1982-1989"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Initially a glam-inspired group [...]"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"band_members"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"David Sylvian in Japan"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"musician"</span><span class="p">:</span><span class="w"> </span><span class="s2">"David Sylvian"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"band"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Japan"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"instruments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Lead vocals, keyboards, guitar"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"joined"</span><span class="p">:</span><span class="w"> </span><span class="mi">1974</span><span class="p">,</span><span class="w">
      </span><span class="s2">"left"</span><span class="p">:</span><span class="w"> </span><span class="mi">1991</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"musicians"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"David Sylvian"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"born"</span><span class="p">:</span><span class="w"> </span><span class="mi">1958</span><span class="p">,</span><span class="w">
      </span><span class="s2">"instruments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Vocals, guitar, keyboards"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"albums"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Gentlemen Take Polaroids"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"band"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Japan"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"released"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1980-10-24T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Virgin"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>To cache this data in your app, you create a suitable Core Data model:</p>

<p><img src="images/model.png" alt=""></p>

<p>And with only a few lines of code, the JSON data is safely persisted in Core Data on your device, relationships and all:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">JSONCache</span>

<span class="o">...</span>

<span class="k">let</span> <span class="nv">jsonObject</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">jsonData</span><span class="p">)</span> <span class="k">as!</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">bands</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">[</span><span class="s">"bands"</span><span class="p">]</span> <span class="k">as!</span> <span class="p">[[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]]</span>
<span class="k">let</span> <span class="nv">bandMembers</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">[</span><span class="s">"band_members"</span><span class="p">]</span> <span class="k">as!</span> <span class="p">[[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]]</span>
<span class="k">let</span> <span class="nv">musicians</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">[</span><span class="s">"musicians"</span><span class="p">]</span> <span class="k">as!</span> <span class="p">[[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]]</span>
<span class="k">let</span> <span class="nv">albums</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">[</span><span class="s">"albums"</span><span class="p">]</span> <span class="k">as!</span> <span class="p">[[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]]</span>

<span class="kt">JSONCache</span><span class="o">.</span><span class="n">casing</span> <span class="o">=</span> <span class="o">.</span><span class="n">snake_case</span>
<span class="kt">JSONCache</span><span class="o">.</span><span class="n">dateFormat</span> <span class="o">=</span> <span class="o">.</span><span class="n">iso8601WithSeparators</span>

<span class="kt">JSONCache</span><span class="o">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="nv">withModelName</span><span class="p">:</span> <span class="s">"Bands"</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
  <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
  <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
    <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">stageChanges</span><span class="p">(</span><span class="nv">withDictionaries</span><span class="p">:</span> <span class="n">bands</span><span class="p">,</span> <span class="nv">forEntityWithName</span><span class="p">:</span> <span class="s">"Band"</span><span class="p">)</span>
    <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">stageChanges</span><span class="p">(</span><span class="nv">withDictionaries</span><span class="p">:</span> <span class="n">bandMembers</span><span class="p">,</span> <span class="nv">forEntityWithName</span><span class="p">:</span> <span class="s">"BandMember"</span><span class="p">)</span>
    <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">stageChanges</span><span class="p">(</span><span class="nv">withDictionaries</span><span class="p">:</span> <span class="n">musicians</span><span class="p">,</span> <span class="nv">forEntityWithName</span><span class="p">:</span> <span class="s">"Musician"</span><span class="p">)</span>
    <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">stageChanges</span><span class="p">(</span><span class="nv">withDictionaries</span><span class="p">:</span> <span class="n">albums</span><span class="p">,</span> <span class="nv">forEntityWithName</span><span class="p">:</span> <span class="s">"Album"</span><span class="p">)</span>
    <span class="kt">JSONCache</span><span class="o">.</span><span class="n">applyChanges</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
      <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Data all nicely tucked in"</span><span class="p">)</span>
      <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>If you receive additional data at a later stage it&rsquo;s even simpler:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">albums</span> <span class="o">=</span> <span class="n">jsonObject</span><span class="p">[</span><span class="s">"albums"</span><span class="p">]</span> <span class="k">as!</span> <span class="p">[[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]]</span>

<span class="kt">JSONCache</span><span class="o">.</span><span class="nf">stageChanges</span><span class="p">(</span><span class="nv">withDictionaries</span><span class="p">:</span> <span class="n">albums</span><span class="p">,</span> <span class="nv">forEntityWithName</span><span class="p">:</span> <span class="s">"Album"</span><span class="p">)</span>
<span class="kt">JSONCache</span><span class="o">.</span><span class="n">applyChanges</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
  <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
  <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Data all nicely tucked in"</span><span class="p">)</span>
  <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='producing-json' class='heading'>Producing JSON</h3>

<p>If your app allows producing as well as consuming data, you can
generate JSON directly from <code>NSManagedObject</code> instances:</p>
<pre class="highlight swift"><code><span class="k">switch</span> <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">fetchObject</span><span class="p">(</span><span class="nv">ofType</span><span class="p">:</span> <span class="s">"Band"</span><span class="p">,</span> <span class="nv">withId</span><span class="p">:</span> <span class="s">"Japan"</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">japan</span><span class="p">):</span>
    <span class="k">var</span> <span class="nv">japan</span> <span class="o">=</span> <span class="n">japan</span> <span class="k">as!</span> <span class="kt">Band</span>
    <span class="n">japan</span><span class="o">.</span><span class="n">otherNames</span> <span class="o">=</span> <span class="s">"Rain Tree Crow"</span>

    <span class="kt">ServerProxy</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="nv">band</span><span class="p">:</span> <span class="n">japan</span><span class="o">.</span><span class="nf">toJSONDictionary</span><span class="p">())</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
      <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
        <span class="k">switch</span> <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Japan as Rain Tree Crow all nicely tucked in"</span><span class="p">)</span>
          <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>To create and persist new objects to the backend, you can either create the <code>NSManagedObject</code> instance first and then use it to generate JSON for the backend, or if you prefer to wait until the record is safely persisted on the backend, you can generate JSON from any <code>struct</code> that adopts the <code><a href="Protocols/JSONifiable.html">JSONifiable</a></code> protocol:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">BandInfo</span><span class="p">:</span> <span class="kt">JSONifiable</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
  <span class="k">var</span> <span class="nv">bandDescription</span><span class="p">:</span> <span class="kt">String</span>
  <span class="k">var</span> <span class="nv">formed</span><span class="p">:</span> <span class="kt">Int</span>
  <span class="k">var</span> <span class="nv">disbanded</span><span class="p">:</span> <span class="kt">Int</span><span class="p">?</span>
  <span class="k">var</span> <span class="nv">hiatus</span><span class="p">:</span> <span class="kt">Int</span><span class="p">?</span>
  <span class="k">var</span> <span class="nv">otherNames</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">u2Info</span> <span class="o">=</span> <span class="kt">BandInfo</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"U2"</span><span class="p">,</span> <span class="nv">bandDescription</span><span class="p">:</span> <span class="s">"Dublin boys"</span><span class="p">,</span> <span class="nv">formed</span><span class="p">:</span> <span class="mi">1976</span><span class="p">,</span> <span class="nv">disbanded</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">hiatus</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">otherNames</span><span class="p">:</span> <span class="s">"Passengers"</span><span class="p">)</span>

<span class="kt">ServerProxy</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="nv">band</span><span class="p">:</span> <span class="n">u2Info</span><span class="o">.</span><span class="nf">toJSONDictionary</span><span class="p">())</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
  <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
  <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="kt">NSEntityDescription</span><span class="o">.</span><span class="nf">insertNewObject</span><span class="p">(</span><span class="nv">forEntityName</span><span class="p">:</span> <span class="s">"Band"</span> <span class="nv">into</span><span class="p">:</span> <span class="kt">JSONCache</span><span class="o">.</span><span class="n">mainContext</span><span class="p">)</span><span class="o">!</span>
    <span class="n">u2</span><span class="o">.</span><span class="nf">setAttributes</span><span class="p">(</span><span class="nv">fromDictionary</span><span class="p">:</span> <span class="n">u2Info</span><span class="p">)</span>

    <span class="k">switch</span> <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
      <span class="nf">print</span><span class="p">(</span><span class="s">"U2 all nicely tucked in"</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">)</span>
      <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<blockquote>
<p><strong>NOTE:</strong> I created the <code><a href="Protocols/JSONifiable.html">JSONifiable</a></code> protocol before <code>Codable</code> came along, and the documentation reflects this. I have not yet tried using JSONCache with <code>Codable</code>, but from what I understand, it should work just fine. However, you may have to write a bit of extra code to get the <code>fromJSONDictionary</code> / <code>toJSONDictionary</code> duality that JSONCache offers for free. That said, I&rsquo;m open to replacing <code><a href="Protocols/JSONifiable.html">JSONifiable</a></code> with <code>Codable</code> in a future release if and when I realise that it makes better sense.</p>
</blockquote>
<h3 id='avoiding-the-pyramid-of-doom' class='heading'>Avoiding the pyramid of doom</h3>

<p>As is seen in the examples above, the asynchronous nature of backend calls and many Core Data operations can result in quite an indented <a href="https://en.wikipedia.org/wiki/Pyramid_of_doom_(programming)">pyramid of doom</a>. To avoid this, overloaded <code>bootstrap()</code> and <code>applyChanges()</code> implementations are available that return a <a href="https://andersblehr.co/JSONCache/Classes/ResultPromise.html"><code><a href="Classes/ResultPromise.html">ResultPromise</a></code></a> instead of taking a closure, thus facilitating fluid sequencing of computations
that produce either a <code>Result</code> (<code>map</code>) or a <code><a href="Classes/ResultPromise.html">ResultPromise</a></code> (<code>flatMap</code>):</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">promise</span> <span class="o">=</span> <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">bootstrap</span><span class="p">(</span><span class="nv">withModelName</span><span class="p">:</span> <span class="s">"Bands"</span><span class="p">)</span>
    <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">fetchObject</span><span class="p">(</span><span class="nv">ofType</span><span class="p">:</span> <span class="s">"Band"</span><span class="p">,</span> <span class="nv">withId</span><span class="p">:</span> <span class="s">"Japan"</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">object</span> <span class="k">in</span>
        <span class="k">let</span> <span class="nv">japan</span> <span class="o">=</span> <span class="n">object</span> <span class="k">as!</span> <span class="kt">Band</span>
        <span class="n">japan</span><span class="o">.</span><span class="n">otherNames</span> <span class="o">=</span> <span class="s">"Rain Tree Crow"</span>
        <span class="k">return</span> <span class="kt">ServerProxy</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="nv">band</span><span class="p">:</span> <span class="n">japan</span><span class="o">.</span><span class="nf">toJSONDictionary</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">JSONCache</span><span class="o">.</span><span class="nf">save</span><span class="p">()</span> <span class="p">}</span>

<span class="n">promise</span><span class="o">.</span><span class="n">await</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">success</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Japan as Rain Tree Crow all nicely tucked in"</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"An error occurred: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h2 id='but-do-tell' class='heading'>But do tell</h2>
<h3 id='key-conversion' class='heading'>Key conversion</h3>

<p>When consuming JSON, JSON keys are converted to Core Data entity attribute names. Conversely, when producing JSON, Core Data entity attribute names (or <code>struct</code> properties) are converted to JSON keys.</p>

<p>Key conversion consists of two steps:</p>

<ol>
<li>Convert between <code>snake_case</code> and <code>camelCase</code> as needed.</li>
<li>Qualify or dequalify reserved words as needed.</li>
</ol>
<h4 id='case-conversion' class='heading'>Case conversion</h4>

<p>The <code><a href="Structs/JSONCache.html#/s:9JSONCacheAAV6casingAB6CasingOvpZ">JSONCache.casing</a></code> configuration parameter tells JSONCache whether the JSON data uses <code>.snake_case</code> or <code>.camelCase</code> in key names. Case conversion is only done if the JSON casing is <code>.snake_case</code>:</p>

<ul>
<li><code>attribute_name</code> becomes <code>attributeName</code> when consuming JSON.</li>
<li><code>attributeName</code> becomes <code>attribute_name</code> when producing JSON.</li>
</ul>
<h4 id='qualifying-reserved-words' class='heading'>Qualifying reserved words</h4>

<p>Some words, such as <code>description</code>, collide with reserved Cocoa names and may not be used as attribute names in Core Data entities. When reserved words are received as keys in JSON data, they are qualified. Specifically, the name of the Core Data entity that will hold the data is prefixed onto the reserved word. If for instance the entity name is <code>EntityName</code>:</p>

<ul>
<li><code>description</code> becomes <code>entityNameDescription</code> when consuming JSON.</li>
<li><code>entityNameDescription</code> becomes <code>description</code> when producing JSON.</li>
</ul>

<p>JSONCache only supports qualifying (prefixing) reserved words with the name of the corresponding entity. Thus, care must be taken when naming Core Data entity attributes whose JSON counterparts represent reserved words.</p>

<p>Currently, JSONCache only supports qualifying the reserved word <code>description</code>. More words may be added in the future. </p>
<h3 id='date-conversion' class='heading'>Date conversion</h3>

<p>JSONCache supports the following JSON date formats:</p>

<ul>
<li>ISO 8601 with separators: <code>2000-08-22T12:28:00Z</code></li>
<li>ISO 8601 without separators: <code>20000822T122800Z</code></li>
<li>Seconds since 00:00 on 1 Jan 1970 as a double precision value:
<code>966947280.0</code></li>
</ul>

<p>Use the <code><a href="Structs/JSONCache.html#/s:9JSONCacheAAV10dateFormatAB04DateC0OvpZ">JSONCache.dateFormat</a></code> configuration parameter to tell JSONCache which format to expect and/or produce.</p>
<h3 id='relationship-mapping' class='heading'>Relationship mapping</h3>
<h4 id='how-to' class='heading'>How to &hellip;</h4>

<p>In order for JSONCache to automatically map a 1:1 or a 1:N relationship, you essentially only need to tell it one thing: The primary key of the object on the &lsquo;1: end&rsquo; of the relationship. You do this in either of two ways:</p>

<ol>
<li>Use the name <code>id</code> for the primary key. (See Figure 1.)</li>
<li>Create a User Info key named <code>JC.isIdentifier</code> for the primary key attribute and assign it the value <code>true</code> or <code>YES</code> (or <code>TRUE</code> or <code>yes</code>; both are case insensitive). (See Figure 2.)</li>
</ol>

<p><img src="images/identifier-1.png" alt=""></p>

<p><em>Figure 1: Marking an entity&rsquo;s primary key by naming it <code>id</code>.</em></p>

<p><img src="images/identifier-2.png" alt=""></p>

<p><em>Figure 2: Marking an entity&rsquo;s primary key by creating a User Info key named <code>JC.isIdentifier</code> and setting it to <code>true</code>.</em></p>

<p>The primary key must be unique within an entity, but not across entities.</p>
<h4 id='but-how' class='heading'>But how &hellip;?</h4>

<p>When JSONCache instantiates or updates an <code>NSManagedObject</code> instance from a JSON dictionary, it does so by inspecting the
<code>NSAttributeDescription</code>s of the <code>NSEntityDescription</code> that describes the underlying entity, and assigns each attribute the corresponding value from the JSON dictionary.</p>

<p>In a second pass, JSONCache inspects the <code>NSRelationshipDescription</code>s of the entity, and for each relationship that is <em>not</em> <code>toMany</code>, it looks up the <code>NSEntityDescription</code> of the destination object. Through a JSONCache extension method on <code>NSEntityDescription</code>, it obtains the primary key of the destination entity. It already knows the primary key <em>value</em> of the destination object from the JSON dictionary, so now it has all the information it needs in order to look it up, either in the set of new objects created from the JSON data, or in Core Data if it already has been persisted. Once it has a reference to the destination object, it hooks up the relationship and moves on to the next item.</p>

<p>Consider the following JSON records:</p>

<p><strong>Band</strong></p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Japan"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"formed"</span><span class="p">:</span><span class="w"> </span><span class="mi">1974</span><span class="p">,</span><span class="w">
  </span><span class="s2">"disbanded"</span><span class="p">:</span><span class="w"> </span><span class="mi">1991</span><span class="p">,</span><span class="w">
  </span><span class="s2">"hiatus"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1982-1989"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Initially a glam-inspired group [...]"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"other_names"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Rain Tree Crow"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p><strong>Album</strong></p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tin Drum"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"band"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Japan"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"released"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1981-11-13T00:00:00Z"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Virgin"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>JSONCache first creates two <code>NSManagedObject</code> instances, one for the band Japan, and one for the <em>Tin Drum</em> album, each holding all the attributes from the corresponding JSON record. Then, in the second pass, JSONCache looks at relationships. The <code>Band</code> entity participates in 2 relationships, <code>albums</code> and <code>members</code> (see the ER diagram above), both of which are <code>toMany</code>, so it does nothing. The <code>Album</code> entity participates in 1 relationship, <code>band</code>, which is <em>not</em>
<code>toMany</code>. Through the <code>NSRelationshipDescription</code> describing the <code>band</code> relationship, JSONCache finds that the destination entity is of type <code>Band</code>, and through the <code>NSEntityDescription</code> describing the destination entity, it finds that it has the primary key <code>name</code>. Now JSONCache has all the information it needs. It looks up a <code>Band</code> object whose <code>name</code> value is the same as the <code>band</code> value in the <code>Album</code> dictionary for the <em>Tin Drum</em> album (i.e., &lsquo;Japan&rsquo;), and finally hooks up the relationship.</p>
<h2 id='installation' class='heading'>Installation</h2>

<p>You can install JSONCache using either <a href="http://cocoapods.org/">CocoaPods</a> or <a href="https://github.com/Carthage/Carthage">Carthage</a>.</p>
<h3 id='cocoapods' class='heading'>CocoaPods</h3>
<pre class="highlight plaintext"><code>pod 'JSONCache'
</code></pre>
<h3 id='carthage' class='heading'>Carthage</h3>
<pre class="highlight plaintext"><code>github "andersblehr/JSONCache" ~&gt; 1.0
</code></pre>
<h3 id='compatibility' class='heading'>Compatibility</h3>

<ul>
<li>Swift 5.x</li>
<li>macOS 10.12 or later</li>
<li>iOS 10.0 or later</li>
<li>watchOS 3.0 or later</li>
<li>tvOS 10.0 or later</li>
</ul>
<h2 id='license' class='heading'>License</h2>

<p>JSONCache is released under the MIT license. See the
<a href="LICENSE">LICENSE</a> file for details.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2019 <a class="link" href="https://twitter.com/andersblehr" target="_blank" rel="external">Anders Blehr</a>. All rights reserved. (Last updated: 2019-10-13)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.11.2</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
